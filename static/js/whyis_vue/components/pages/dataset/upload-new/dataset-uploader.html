<div>
    <template>
        <div>
          <div v-if="loading">
            <spinner :loading="loading" :text='loadingText'/>
          </div>
          <div v-else-if="!authenticated">
            <div>Error: user must be logged in to access this page.</div>
          </div>
          <div v-else>
           <div class=""></div>
            <!--------->
            <md-card style="margin: 10px" >
                <form class="modal-content" action="" method="post" 
                  enctype="multipart/form-data" 
                  upload_type="http://www.w3.org/ns/dcat#Dataset">
                <md-steppers :md-active-step.sync="active" md-linear>
        
                  <md-step id="first" md-label="Upload files" :md-done.sync="first">  
                     <div style="margin: 20px">

                      <md-field style="max-width: 100%;"> 
                        <label>DOI of related publication (e.g., 10.1000/000)</label>
                        <md-input v-model="doi"></md-input>
                      </md-field>
        
                        <md-field style="max-width: none;" :class="{ 'md-invalid': isInvalidUpload }"> 
                          <label>Upload distributions (multiple allowed)</label>
                          <md-file v-model="distr_upload" id="distrFiles" multiple required isInvalidValue=false
                            v-on:change="handleDistrUpload($event.target.files)"/> 
                          <span style="color: red;" v-if="distrStatus === 3">Error in upload. Please try again</span>
                          <span class="md-error" style="margin-left:40px">At least one distribution is required</span>
                        </md-field>
                        <div class="large-12 medium-12 small-12 cell" style="margin:20px">
                          <div 
                            v-for="(file, key) in uploadedFiles" 
                            v-bind:key="key + 'listing'"
                            class="file-listing">
                            <div class="md-layout" style="margin-left:10px; align-items: center;">
                              <div class="md-layout-item">{{ file.name }}  </div>
                              <md-button class="remove-file md-raised" v-on:click="removeFile( key )">Remove file</md-button> 
                            </div>
                          </div>
                        </div>  
              
                        <md-field style="max-width: none;">
                          <label>Upload a representative image to use as thumbnail</label>
                          <md-file 
                            id="repImgUploader" v-model="rep_image" accept="image/*" 
                            v-on:change="handleImgUpload($event.target.files); previewFile()"/>
                          <span style="color: red;" v-if="depictStatus === 3">Error in upload. Please try again</span>
                        </md-field>
                        <div id="depictWrapper" style="margin-left: 40px; visibility: hidden;">
                          <figure>
                            <img id="depictImg" src="" alt="Image preview..."  style="height:200px"> 
                            <figcaption>{{ dataset.depiction.name }}</figcaption>
                          </figure> 
                          <md-button style="margin-left: 40px;" type="button" class="close md-raised" @click="removeImage()">Remove image</md-button>
                        </div>
                      </div>
                      <md-button 
                        class="md-raised md-primary" 
                        @click="checkFirstPage()">
                        Upload and continue
                      </md-button> 
    
                    </md-step>
        
        
                    <md-step id="second" md-label="Provide additional info" :md-done.sync="second">
                    
                      <div class="md-layout">
        
                        <!---------- General Info fields ---------->
                        <md-content style="width: 100%; margin: 20px">
                          <div class="md-headline" style="margin-top: 10px">
                            General Information
                          </div>
                          <md-field style="max-width: 100%;" :class="{ 'md-invalid': (isInvalidForm && (dataset.title === ''))}"> 
                            <label>Title</label>
                            <md-input v-model="dataset.title" required></md-input>
                            <span class="md-error">Title required</span>
                          </md-field>


                          <div class="md-subheading" style="margin-top: 40px;">Contact Point</div> 
                          <div class="md-layout md-gutter" style="align-items: center;">  

                            <div class="md-layout-item md-size-25">
                              <md-field :class="{ 'md-invalid': (isInvalidForm && (dataset.contactpoint['@id']=== null))}">
                                <label>ORCID Identifier</label>
                                <md-input v-model="dataset.contactpoint['@id']" required></md-input>
                                <span class="md-error">ORCID iD required</span>
                              </md-field>
                            </div>
                      
                            <div class="md-layout-item md-size-25">
                              <md-field :class="{ 'md-invalid': (isInvalidForm && (dataset.contactpoint.cpfirstname === ''))}">
                                <label>First name</label>
                                <md-input v-model="dataset.contactpoint.cpfirstname" required></md-input>
                                <span class="md-error">Contact point required</span>
                              </md-field>
                            </div>
                      
                            <div class="md-layout-item md-size-25">
                              <md-field :class="{ 'md-invalid': (isInvalidForm && (dataset.contactpoint.cplastname === ''))}">
                                <label>Last name</label>
                                <md-input v-model="dataset.contactpoint.cplastname" required></md-input>
                                <span class="md-error">Contact point required</span>
                              </md-field>
                            </div>
                      
                            <div class="md-layout-item md-size-25">
                              <md-field :class="{ 'md-invalid': (isInvalidForm && (dataset.contactpoint.cpemail === ''))}">
                                <label>Email</label>
                                <md-input v-model="dataset.contactpoint.cpemail" required></md-input>
                                <span class="md-error">Valid email required</span>
                              </md-field>
                            </div>
                          </div> 

                          <div style="margin-bottom: 40px; text-align: center;">
                            Don't have an ORCID iD?
                            <a href="https://orcid.org/" target="_blank">Create one here</a>
                          </div>
        
                          <md-field style="max-width: 100%;" :class="{ 'md-invalid': (isInvalidForm && (dataset.description === ''))}">
                            <label>Text Description</label>
                            <md-textarea v-model="dataset.description" required></md-textarea>
                            <span class="md-error">Description required</span>
                          </md-field>
     
                        </md-content>
                    
                        <md-divider style="border-style: solid" width="100%"></md-divider>
        
        
                        <!---------- Contributor fields -------->
                        <md-content style="width: 100%; margin: 20px">
                          <div class="md-headline" style="margin-top: 10px; margin-bottom: 10px"> 
                            Contributors
                          </div>

                          <div v-if="authorFirst"> 
                          <!------TOLU: Here is where the autocomplete field starts.
                                This is the made up version from the Vue Material documentation, 
                                the real version is in md-autocomplete.html ----->
                          <md-autocomplete 
                            style="width: 90%"
                            v-model="selectedAuthor" 
                            :md-options="autocomplete.availableAuthors" 
                            :md-open-on-focus="false" 
                            @md-changed="resolveEntityAuthor"
                            @md-selected="selectedAuthorChange" >
                            <label>Country</label>
                      
                            <template slot="md-autocomplete-item" slot-scope="{ item, term }">
                              <md-highlight-text :md-term="term">{{ item.label }}</md-highlight-text>
                            </template>
                      
                            <template slot="md-autocomplete-empty" slot-scope="{ term }">
                              No countries matching "{{ term }}" were found. <a @click="noop()">Create a new</a> one!
                            </template>
                          </md-autocomplete>
                          <!-------------Autocomplete ends here------------->

                          <table class="table" width="100%" style="border-collapse: collapse;">
                            <tbody>
                              <tr > 
                              <td style="width:100%">  
                                <tr v-for="(row, index) in contributors2" 
                                  v-bind:key="index + 'contr2'" 
                                  style="border-top: 0.5pt lightgray solid"
                                >
                                  <td style="width:50%">
                                    {{contributors2[index]['name']}}
                                  </td>
                                  <td style="width:50%">
                                    <md-autocomplete 
                                      style="max-width: 90%;" 
                                      v-model="row['onbehalfof']['name']" 
                                      :md-options="autocomplete.availableInstitutions" 
                                      :md-open-on-focus="false"
                                      @md-changed="resolveEntityInstitution"
                                    >
                                      <label>Organization</label>
                          
                                      <template style="max-width: 90%;" slot="md-autocomplete-item" slot-scope="{ item, term }">
                                        <md-highlight-text :md-term="term">{{ item }}</md-highlight-text>
                                      </template>
                          
                                      <template style="max-width: 90%;" slot="md-autocomplete-empty" slot-scope="{ term }">
                                        <p>No organizations matching "{{ term }}" were found.</p>
                                        <a v-on:click="showNewInstitution" style="cursor: pointer">Create new</a> 
                                      </template>
                                    </md-autocomplete>

                                  </td>
                                  <td>
                                    <a v-on:click="removeElement2(index)" style="cursor: pointer" >Remove</a> 
                                  </td>
                                </tr>
                              </td> 
                              </tr>
                            </tbody>

                          </table> 
                        </div>
                      
                          <table class="table" width="100%" v-else> 
                            <tbody>
                              <tr v-for="(row, index) in contributors" v-bind:key="index + 'contr'"> 
                              <td style="width:100%"> 
                                <tr  style="width:100%">
                                  <td style="width:50%"> 
                                    <md-autocomplete 
                                      style="max-width: 90%;" 
                                      v-model="row['org']" 
                                      :md-options="autocomplete.availableInstitutions" 
                                      :md-open-on-focus="false"
                                      @md-changed="resolveEntityInstitution"
                                    >
                                      <label>Organization</label>
                          
                                      <template style="max-width: 90%;" slot="md-autocomplete-item" slot-scope="{ item, term }">
                                        <md-highlight-text :md-term="term">{{ item }}</md-highlight-text>
                                      </template>
                          
                                      <template style="max-width: 90%;" slot="md-autocomplete-empty" slot-scope="{ term }">
                                        <p>No organizations matching "{{ term }}" were found.</p>
                                        <a v-on:click="showNewInstitution" style="cursor: pointer">Create new</a> 
                                      </template>
                                    </md-autocomplete>
                                  </td>
                                  <td style="width:20px"></td>
                                  <td style="width:50%">
                                    <md-autocomplete 
                                      style="max-width: 90%;" 
                                      v-model="selectedAuthor[index]" 
                                      :md-options="autocomplete.availableAuthors" 
                                      :md-open-on-focus="false" 
                                      @md-changed="resolveEntityAuthor"
                                      @md-selected="selectAuthor(index)" 
                                    >
                                      <label>Authors from this Institution</label>
                          
                                      <template style="max-width: 90%;" slot="md-autocomplete-item" slot-scope="{ item, term }">
                                        <md-highlight-text :md-term="term">{{ item }}</md-highlight-text>
                                      </template>
                          
                                      <template style="max-width: 90%;" slot="md-autocomplete-empty" slot-scope="{ term }">
                                        <p>No authors matching "{{ term }}" were found.</p>
                                        <a v-on:click="showNewAuthor" style="cursor: pointer">Create new</a>
                                      </template>
                                    </md-autocomplete>
                                  </td>
                                  <td>
                                    <a v-on:click="removeElement(index)" style="cursor: pointer"
                                      >Remove</a
                                    >
                                  </td>
                                </tr>
    
                                <tr>
                                  <td></td>
                                  <td></td>
                                  <td> 
                                    <md-chip 
                                      v-for="(auth, ind) in row['authors']" 
                                      v-bind:key="ind + 'authors'" 
                                      class="md-primary">{{auth}}
                                      <button @click="removeAuthor(ind, index)">x</button>
                                    </md-chip> 
                                  </td>
                                  <td></td>
                                </tr> 
    
                              </td> 
                              </tr>
                            </tbody>
                          </table>

                          <div v-if="!authorFirst"> 
                            <md-button
                              class="md-raised"
                              @click="addOrg()"
                              style="margin: 10px"
                            >
                              Add row
                            </md-button>
                          </div>
                        </md-content>
        
                        <md-divider style="border-style: solid" width="100%"></md-divider>
                    
                        <!-- -------- Publication Info fields -------- -->
                        <md-content style="width: 100%; margin: 20px">
                          <div class="md-headline" style="margin-top: 10px; margin-bottom: 10px">
                            Publication Information
                          </div>
                      
                          <div style="width: 100%">
                            <div class="md-layout md-gutter">
                              <div class="md-layout-item md-size-50">
                                <label>Date Published</label>
                                <md-field>
                                  <md-input v-model="dataset.datepub['@value']" type="date"
                                  :formatter="dateFormat"></md-input>
                                </md-field>
                              </div>
                      
                              <div class="md-layout-item md-size-50">
                                <label>Date Last Modified</label>
                                <md-field>
                                  <md-input v-model="dataset.datemod['@value']" type="date" 
                                  :formatter="dateFormat"></md-input>
                                </md-field>
                              </div>
                            </div>
                            
                            <!--------Now on first page-------->
                            <!-- <div>
                              <label>DOI(s) of Related Publication(s)</label> 
                              <md-field style="max-width: none;">
                                <md-input 
                                  v-model="dois" 
                                  v-on:input="editDois"
                                  placeholder="E.g.: 10.1000/182"
                                ></md-input>
                                <span class="md-helper-text">Separate multiple DOIs with a comma or space</span>
                              </md-field>
                            </div>  -->
                            
                          </div>
                        </md-content> 
                        <md-button class="md-raised md-primary" @click="checkSecondPage">Next</md-button>
                        <span v-if="isInvalidForm" class="md-error" style="color:red">Check for errors in required fields</span>
                      </div> 
                    </md-step>
        
                    <md-step id="third" md-label="Confirm and Submit" :md-done.sync="third">
        
                      <div class="md-headline" style="margin: 10px">
                        Form Results
                      </div>
                      <md-content style="width: 100%; margin: 20px">
                        <span>Title: {{ dataset.title }}</span>
                        <p>
                          Contact Point: {{ dataset.contactpoint.cpfirstname }} 
                          {{ dataset.contactpoint.cplastname }} - 
                          {{ dataset.contactpoint.cpemail }}
                        </p>
                        <p>Text Description: {{ dataset.description }}</p>
                        <span>Contributors</span>
                        <div
                          v-if="authorFirst"
                          style="margin-left: 20px"
                          v-for="(elem, index) in contributors2"
                          v-bind:key="index + 'resContr2'"
                        >
                          <span>{{elem.name}}</span>
                          <template v-if="elem.onbehalfof.name !== 'N/A'"> - {{elem.onbehalfof.name}}</template>
                        </div> 
                        <div
                          v-if="!authorFirst"
                          style="margin-left: 20px"
                          v-for="(elem, index) in contributors"
                          v-bind:key="index + 'resContr'"
                        >
                          {{ elem.org }}: 
                          <div 
                            style="margin-left:20px"
                            v-for="(auth, index) in elem.authors" 
                            v-bind:key="index + 'resAuth'"> 
                            - {{ auth }}
                          </div> 
                        </div>
                        <p>Date Published: {{ dataset.datepub['@value'] }}</p>
                        <p>Date Last Modified: {{ dataset.datemod['@value'] }}</p>
                        <p> Related publications </p>
                        <div style="margin-left: 20px">
                          {{ dataset.refby }}
                        </div>
                        <!-- <div
                          style="margin-left: 20px"
                          v-for="(ref, index) in dataset.refby"
                          v-bind:key="index+'doi'"
                        >
                          {{ dataset.refby[index] }}
                        </div> -->
                        <p style="margin-top:10px">Distribution(s):</p> 
                        <div 
                          v-for="(file, key) in uploadedFiles" 
                          v-bind:key="key+'confirm'" 
                          style="margin-left:20px;"> 
                          {{ file.name }} 
                        </div>
                        <p>Representative Image: {{ rep_image }}</p>
                      </md-content>
        
                      <md-card-actions>
                        <md-button v-on:click="submitForm" class="md-primary"
                          >Submit</md-button
                        >
                      </md-card-actions>
        
                    </md-step>
                </md-steppers>
                </form>
              </md-card>
            <!--------->
            <md-speed-dial :class="bottomPosition" v-if="speedDials">
              <md-speed-dial-target class="utility-float-icon">
                <md-icon>menu</md-icon>
              </md-speed-dial-target>
      
              <md-speed-dial-content>
                <md-button class="md-icon-button" @click.prevent="cancelFilter">
                  <md-tooltip class="utility-bckg" md-direction="left"> Cancel Filter </md-tooltip>
                  <md-icon class="utility-color">search_off</md-icon>
                </md-button>
                <md-button class="md-icon-button" @click="null">
                  <md-tooltip class="utility-bckg" md-direction="left"> Filter </md-tooltip>
                  <md-icon class="utility-color">search</md-icon>
                </md-button>
                <md-button class="md-icon-button" v-if="authenticated !== undefined" @click.prevent="null">
                  <md-tooltip class="utility-bckg" md-direction="left">Create New Chart</md-tooltip>
                  <md-icon class="utility-color">add</md-icon>
                </md-button>
              </md-speed-dial-content>
            </md-speed-dial>
          </div>
        </div>
      </template>
    </div>
